<UserControl x:Class="Metra.Desktop.Views.Pages.FilialPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d"
             Background="Transparent"
             d:DesignHeight="800" d:DesignWidth="1200">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <!-- Converters -->
            </ResourceDictionary.MergedDictionaries>

            <!-- BoolToVisibilityConverter -->
            <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        </ResourceDictionary>
    </UserControl.Resources>
    <Grid Background="{StaticResource BackgroundColor}">
        <!-- Loading Overlay -->
        <Border Background="#80000000"
                Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}"
                Panel.ZIndex="999">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                             Width="60" Height="60"
                             IsIndeterminate="True"
                             Foreground="{StaticResource HeaderColor}"/>
                <TextBlock Text="Yuklanmoqda..."
                           Foreground="White"
                           FontSize="16"
                           Margin="0,20,0,0"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <Grid Margin="20" >
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            <!-- Toolbar -->
            <Border Grid.Row="0" Style="{StaticResource CardBorderWithMarginStyle}" Margin="10 0 10 0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Search Box -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Left">
                        <Button Style="{StaticResource PrimaryButtonStyle}"
                                Command="{Binding OpenAddDialogCommand}"
                                Margin="0,0,10,0">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Plus"
                                                         Width="18" Height="18"
                                                         VerticalAlignment="Center"/>
                                <TextBlock Text="Yangi filial"
                                           Margin="8,0,0,0"
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <Button Style="{StaticResource IconButtonStyle}"
                                Command="{Binding RefreshCommand}"
                                ToolTip="Yangilash">
                            <materialDesign:PackIcon Kind="Refresh"
                                                     Width="20" Height="20"/>
                        </Button>
                    </StackPanel>
                    <Border Grid.Column="1" Style="{StaticResource SearchBoxBorderStyle}"
                            MaxWidth="400" HorizontalAlignment="Left">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0"
                                     Style="{StaticResource SearchTextBoxStyle}"
                                     Foreground="{StaticResource TextBoxForegraund}"
                                     materialDesign:HintAssist.Foreground="{StaticResource TextBoxForegraund}"
                                     Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                     materialDesign:HintAssist.Hint="Filial nomini qidirish..."/>
                            <materialDesign:PackIcon Kind="Magnify"
                                                     Grid.Column="1"
                                                     Width="20" Height="20"
                                                     Foreground="{StaticResource SecundaryBackgroundColor}"
                                                     VerticalAlignment="Center"
                                                     HorizontalAlignment="Right"
                                                     Margin="10,0,5,0"/>
                        </Grid>
                    </Border>

                    <!-- Action Buttons -->
                </Grid>
            </Border>

            <!-- DataGrid -->
            <Border Grid.Row="1" Style="{StaticResource CardBorderStyle}">
                <DataGrid ItemsSource="{Binding Filials}"
                          Style="{StaticResource StandardDataGridStyle}"
                          SelectedItem="{Binding SelectedFilial}"
                          MouseDoubleClick="DataGrid_MouseDoubleClick"
                          MouseRightButtonUp="DataGrid_MouseRightButtonUp">

                    <DataGrid.Columns>
                        <!-- # -->
                        <DataGridTextColumn Header="#" Visibility="Visible" HeaderStyle="{StaticResource CustomDataGridColumnHeaderStyle}"
                                            Binding="{Binding Number}"/>

                        <!-- Filial nomi -->
                        <DataGridTextColumn Header="Filial nomi" HeaderStyle="{StaticResource CustomDataGridColumnHeaderStyle}"
                                            Binding="{Binding Name}"
                                            Width="*"/>

                            <!-- Turi -->
                        <DataGridTextColumn Header="Turi" HeaderStyle="{StaticResource CustomDataGridColumnHeaderStyle}"
                                            Binding="{Binding TypeDisplay}"
                                            Width="150"
                                            IsReadOnly="True"/>

                        <!-- Ta'rif -->
                        <DataGridTextColumn Header="Ta'rif" HeaderStyle="{StaticResource CustomDataGridColumnHeaderStyle}"
                                            Binding="{Binding Description}"
                                            Width="*"
                                            MinWidth="200"
                                            IsReadOnly="True"/>

                        <!-- Mas'ul xodim -->
                        <DataGridTextColumn Header="Mas'ul xodim" HeaderStyle="{StaticResource CustomDataGridColumnHeaderStyle}"
                                            Binding="{Binding ResponsibleWorker}"
                                            Width="200"
                                            IsReadOnly="True"/>

                        <!-- Yaratilgan sana -->
                        <DataGridTextColumn Header="Yaratilgan sana" HeaderStyle="{StaticResource CustomDataGridColumnHeaderStyle}"
                                            Binding="{Binding Date}"
                                            Width="150"
                                            IsReadOnly="True"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Border>
        </Grid>

        <!-- Context Menu (O'chirish uchun) -->
        <Border Background="#80000000"
                Visibility="{Binding IsContextMenuOpen, Converter={StaticResource BoolToVisibilityConverter}}"
                Panel.ZIndex="999"
                MouseLeftButtonDown="ContextMenuOverlay_MouseLeftButtonDown">
            <Border Background="{StaticResource BackgroundColor}"
                    BorderBrush="{StaticResource HeaderColor}"
                    BorderThickness="2"
                    CornerRadius="8"
                    Padding="15"
                    Width="250"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center">
                <StackPanel>
                    <!-- Sarlavha -->
                    <TextBlock Text="Filialni o'chirish"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Foreground="{StaticResource HeaderColor}"
                               Margin="0,0,0,15"/>

                    <!-- Ma'lumot -->
                    <TextBlock TextWrapping="Wrap"
                               Foreground="{StaticResource TextBoxForegraund}"
                               Margin="0,0,0,20">
                        <Run Text=""/>
                        <Run Text="{Binding SelectedFilial.Name, Mode=OneWay}" FontWeight="SemiBold"/>
                        <Run Text=" filialini o'chirmoqchimisiz?"/>
                    </TextBlock>

                    <!-- Buttonlar -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="10"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Bekor qilish -->
                        <Button Grid.Column="0"
                                Style="{StaticResource OutlineButtonStyle}"
                                Command="{Binding CloseContextMenuCommand}"
                                Content="Bekor qilish"
                                Height="35"/>

                        <!-- O'chirish -->
                        <Button Grid.Column="2"
                                Command="{Binding DeleteFilialCommand}"
                                Height="35"
                                Background="#DC3545"
                                Foreground="White"
                                BorderThickness="0"
                                FontWeight="SemiBold"
                                Cursor="Hand">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}"
                                                        CornerRadius="5"
                                                        Padding="10,5">
                                                    <ContentPresenter HorizontalAlignment="Center"
                                                                      VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#C82333"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <materialDesign:PackIcon Kind="Delete"
                                                         Width="16" Height="16"
                                                         VerticalAlignment="Center"/>
                                <TextBlock Text="O'chirish"
                                           Margin="5,0,0,0"
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </Grid>
                </StackPanel>
            </Border>
        </Border>

        <!-- Add/Edit Dialog -->
        <Border Background="#80000000"
                Visibility="{Binding IsAddEditDialogOpen, Converter={StaticResource BoolToVisibilityConverter}}"
                Panel.ZIndex="1000">
            <Border Style="{StaticResource DialogBorderStyle}"
                    Width="500"
                    MaxHeight="600"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Dialog Header -->
                    <Border Grid.Row="0"
                            Background="{StaticResource HeaderColor}"
                            CornerRadius="10,10,0,0"
                            Padding="20,15">
                        <Grid>
                            <TextBlock Text="{Binding DialogTitle}"
                                       Foreground="White"
                                       FontSize="18"
                                       FontWeight="SemiBold"/>

                            <Button Style="{StaticResource IconButtonStyle}"
                                    Command="{Binding CloseDialogCommand}"
                                    HorizontalAlignment="Right"
                                    Background="Transparent">
                                <materialDesign:PackIcon Kind="Close"
                                                         Width="24" Height="24"
                                                         Foreground="White"/>
                            </Button>
                        </Grid>
                    </Border>

                    <!-- Dialog Content -->
                    <ScrollViewer Grid.Row="1"
                                  VerticalScrollBarVisibility="Auto"
                                  Padding="20">
                        <StackPanel>
                            <!-- Filial nomi -->
                            <TextBlock Text="Filial nomi *"
                                       Style="{StaticResource LabelTextStyle}"
                                       Margin="0,0,0,8"/>
                            <TextBox Style="{StaticResource MaterialTextBoxStyle}"
                                     Text="{Binding FilialName, UpdateSourceTrigger=PropertyChanged}"
                                     materialDesign:HintAssist.Hint="Filial nomini kiriting"
                                     Margin="0,0,0,20"/>

                            <!-- Filial turi -->
                            <TextBlock Text="Filial turi *"
                                       Style="{StaticResource LabelTextStyle}"
                                       Margin="0,0,0,8"/>
                            <ComboBox SelectedValue="{Binding FilialType}"
                                      SelectedValuePath="Tag"
                                      materialDesign:HintAssist.Hint="Filial turini tanlang"
                                      Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                      Margin="0,0,0,20">
                                <ComboBoxItem Content="Asosiy" Tag="main"/>
                                <ComboBoxItem Content="Asosiy ombor" Tag="general"/>
                                <ComboBoxItem Content="Filial" Tag="branch" IsSelected="True"/>
                                <ComboBoxItem Content="Ombor" Tag="store"/>
                            </ComboBox>

                            <!-- Ta'rif -->
                            <TextBlock Text="Ta'rif"
                                       Style="{StaticResource LabelTextStyle}"
                                       Margin="0,0,0,8"/>
                            <TextBox Style="{StaticResource MultilineTextBoxStyle}"
                                     Text="{Binding FilialDescription, UpdateSourceTrigger=PropertyChanged}"
                                     materialDesign:HintAssist.Hint="Filial haqida qo'shimcha ma'lumot"
                                     Height="100"
                                     TextWrapping="Wrap"
                                     AcceptsReturn="True"
                                     VerticalScrollBarVisibility="Auto"/>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- Dialog Footer -->
                    <Border Grid.Row="2"
                            BorderBrush="{StaticResource BorderColor}"
                            BorderThickness="0,1,0,0"
                            Padding="20,15">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Style="{StaticResource OutlineButtonStyle}"
                                    Command="{Binding CloseDialogCommand}"
                                    Content="Bekor qilish"
                                    Margin="0,0,10,0"
                                    Width="120"/>

                            <Button Style="{StaticResource PrimaryButtonStyle}"
                                    Command="{Binding SaveFilialCommand}"
                                    Width="120">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="ContentSave"
                                                             Width="18" Height="18"
                                                             VerticalAlignment="Center"/>
                                    <TextBlock Text="Saqlash"
                                               Margin="8,0,0,0"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>
        </Border>
    </Grid>
</UserControl>
